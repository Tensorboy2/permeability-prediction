# Permeability Prediction
By Sigurd SÃ¸nvisen Vargdal

This repository contains code for generating data and training deep learning image methods on prediction of permeability.


## Data
The data generation involves: generating synthetic periodic porous medium with arbitrary geometry and running Lattice-Boltzmann simulations on the medium to obtain the respective *permeability* tensor.

The porous media is generated using a periodic version of the **binary_blobs** function from SciKit-Image. Each medium is required to percolate in both the x and y direction. We fill disconnected fluid clusters to obtain the image filled version of each medium. For flow simulations we use the Lattice-Boltzmann method with the $D2Q9$ lattice. With the obtained velocity field we compute the permeability using Darcy's law. 

The data is available as: \href{} 
From the Zenodo download you must put the files in the following folders:
- data/
    - images.npy
    - images_filles.npy
    - train_and_val.npy
    - test_images.npy
    - test_images_filled.npy
    - test_k.npy
- models/
    - ConvNeXtTiny_500_epochs.pth
    - ConvNeXtSmall_400_epochs.pth
    - ResNet50_500_epochs.pth
    - ResNet101_400_epochs.pth
    - ViT_S16.pth
    - ViT-T16.pth
- results/
    - all_models_similarity_filled.npz

Alternatively, generate the data using:
```bash
python3 data/generate_images.py
```
Then generate the test images with:
```bash
python3 data/generate_test_images.py
```
The simulation is performed using MPI with one process per sample. So for 8 cores run:
```bash
mpirun -np 8 data/simulation_pipeline.py
```
This will run the simulation on the simulations on the training, validation, and the test data. The resulting permeability is for convenience stored in folders. to convert these folders to **npy** objects, the **to_npy.py** script can be used.

## Models and Training
The models are built and trained using the PyTorch frame work. It is a resource intensive process and was done on Nvidia GPUs (A4000,A100,P100).

To execute the training yaml configs are used with needed hyperparameters. The training yamls can be generated using the scripts inside the **config/** folder. This can be done to fit *Slurm* execution.

## Plotting
The demo plots of the periodic medium with velocity field can be made with **demo_periodic_media.py**. It also produces the domain itself used to demonstrate the augmentations.

The distribution of permeability and porosity requires the dataset in the data folder, and is generated by **perm_vs_por_plot.py**

The plots inside **results/**, can be made with the csv's in the folder.

The similarity plots are made from **all_models_similarity_filled.npz**, which contains the target and prediction of each of the best models state\_dicts. **plot_similarity.py** produces the final similarity plots with the Kozeny-Carman fit, ConvNeXt-Small, and ViT-T16.


